@model List<AparAppsWebsite.Models.IntervalPetugas>
@{
    ViewData["Title"] = "Interval Petugas";
    var total = Model?.Count ?? 0;
}

<style>
    .toolbar .form-control {
        min-width: 260px;
    }

    .toolbar .btn {
        border-radius: .45rem;
    }

    .k-chip {
        font-size: .8rem;
        border: 1px solid rgba(0, 0, 0, .06);
        background: var(--bs-light);
    }

    .sticky-head th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--bs-body-bg);
    }

    .table-hover tbody tr:hover {
        filter: brightness(.98);
    }
</style>

<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">

            <!-- Alerts -->
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success d-flex align-items-center gap-2">
                    <i class="fas fa-check-circle"></i><span>@TempData["Success"]</span>
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger d-flex align-items-center gap-2">
                    <i class="fas fa-times-circle"></i><span>@TempData["Error"]</span>
                </div>
            }
            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger d-flex align-items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i><span>@ViewBag.Error</span>
                </div>
            }

            <div class="card border-0 shadow-sm">
                <!-- HEADER: title + toolbar -->
                <div class="card-header">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-start gap-3">
                            <div>
                                <h3 class="card-title mb-0">Interval Petugas</h3>
                                <div class="small text-muted">Kelola nama interval, durasi (bulan), dan deskripsi.</div>
                            </div>
                            <span id="countBadge" class="badge bg-secondary align-self-center">@total data</span>
                        </div>

                        <!-- Toolbar kanan: tombol aksi utama -->
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            @* <button id="btnExport" class="btn btn-outline-secondary">
                                <i class="fas fa-file-export"></i> Export CSV
                            </button> *@
                            <a class="btn btn-primary" href="@Url.Action("Create")">
                                <i class="fas fa-plus"></i> Tambah
                            </a>
                        </div>
                    </div>

                    <!-- Toolbar bawah: filter/search -->
                    <div class="toolbar d-flex flex-wrap align-items-end gap-2 mt-2">
                        <div class="input-group" style="max-width:520px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input id="searchInput" type="text" class="form-control"
                                placeholder="Cari nama interval / deskripsi">
                            <button id="btnReset" class="btn btn-light border" type="button">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                        @* <span class="badge k-chip"><i class="fas fa-filter"></i> Filter hanya mempengaruhi tampilan
                            tabel</span> *@
                    </div>
                </div>

                <div class="card-body">
                    @if ((Model?.Count ?? 0) == 0)
                    {
                        <div class="alert alert-info d-flex align-items-start gap-2">
                            <i class="fas fa-info-circle mt-1"></i>
                            <div>
                                <div class="fw-semibold">Belum ada data interval petugas.</div>
                                <div class="small">Klik <em>Tambah</em> untuk menambahkan interval baru.</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table id="intervalTable" class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-head">
                                    <tr>
                                        @* <th style="width:80px;">ID</th> *@
                                        <th>Nama Interval</th>
                                        <th style="width:140px;">Bulan</th>
                                        <th style="width:240px;">Deskripsi</th>
                                        <th style="width:180px;" class="text-end">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var x in Model)
                                    {
                                        <tr data-nama="@(x.NamaInterval ?? "")" data-desc="@(x.Deskripsi ?? "")">
                                            @* <td>@x.Id</td> *@
                                            <td class="fw-semibold">@x.NamaInterval</td>
                                            <td>
                                                <span class="badge bg-warning text-dark">
                                                    @(x.Bulan.HasValue? x.Bulan.Value : 0) bln
                                                </span>
                                            </td>
                                            <td><small>@(string.IsNullOrWhiteSpace(x.Deskripsi) ? "-" : x.Deskripsi)</small>
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group" role="group">
                                                    <a class="btn btn-sm btn-outline-secondary"
                                                        href="@Url.Action("Details", new { id = x.Id })" title="Detail">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a class="btn btn-sm btn-outline-warning"
                                                        href="@Url.Action("Edit", new { id = x.Id })" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                        onclick="confirmDelete(@x.Id, '@x.NamaInterval')" title="Hapus">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="small text-muted mt-2">
                            Menampilkan <span id="shownCount">@total</span> dari @total entri.
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal Delete -->
<div class="modal fade" id="delModal" tabindex="-1" aria-labelledby="delModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="delModalLabel" class="modal-title">Hapus Interval</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
            </div>
            <div class="modal-body">
                Hapus interval <strong id="delName"></strong>?<br />
                <small class="text-danger">Jika sedang dipakai Petugas, penghapusan akan ditolak.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <form id="delForm" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">Hapus</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const $search = document.getElementById('searchInput');
            const $reset = document.getElementById('btnReset');
            const $table = document.getElementById('intervalTable');
            const $rows = Array.from($table?.querySelectorAll('tbody tr') || []);
            const $count = document.getElementById('countBadge');
            const $shown = document.getElementById('shownCount');
            const $export = document.getElementById('btnExport');

            function applyFilter() {
                const q = ($search?.value || '').toLowerCase();
                let visible = 0;
                $rows.forEach(tr => {
                    const nama = (tr.dataset.nama || '').toLowerCase();
                    const desc = (tr.dataset.desc || '').toLowerCase();
                    const show = !q || nama.includes(q) || desc.includes(q);
                    tr.style.display = show ? '' : 'none';
                    if (show) visible++;
                });
                if ($count) $count.textContent = `${visible} data`;
                if ($shown) $shown.textContent = visible;
            }

            function resetFilter() {
                if ($search) $search.value = '';
                applyFilter();
            }

            function exportCSV() {
                if (!$table) return;
                const visibleRows = Array.from($table.querySelectorAll('tbody tr'))
                    .filter(tr => tr.style.display !== 'none');
                const header = ['ID', 'Nama Interval', 'Bulan', 'Deskripsi'];
                const lines = [header.join(',')];

                const esc = v => {
                    if (v == null) return '';
                    const s = String(v).replace(/"/g, '""');
                    return /[",\n]/.test(s) ? `"${s}"` : s;
                };

                visibleRows.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    const id = tds[0]?.innerText.trim();
                    const nama = tds[1]?.innerText.trim();
                    const bln = tds[2]?.innerText.trim();
                    const desc = tds[3]?.innerText.trim();
                    lines.push([id, nama, bln, desc].map(esc).join(','));
                });

                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                a.href = url; a.download = `interval-petugas-${ts}.csv`;
                document.body.appendChild(a); a.click(); a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 500);
            }

            $search?.addEventListener('input', applyFilter);
            $reset?.addEventListener('click', resetFilter);
            $export?.addEventListener('click', exportCSV);

            applyFilter();

            // Modal delete
            window.confirmDelete = function (id, name) {
                document.getElementById('delName').textContent = name || ('ID ' + id);
                document.getElementById('delForm').action = '@Url.Action("Delete")/' + id;
                new bootstrap.Modal(document.getElementById('delModal')).show();
            };
        })();
    </script>
}
