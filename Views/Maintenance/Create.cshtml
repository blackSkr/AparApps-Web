@model AparAppsWebsite.Models.Maintenance
@{
    ViewData["Title"] = "Pemeriksaan Baru";
}

<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12 d-flex align-items-center justify-content-between">
            <h3 class="mb-0">Pemeriksaan Baru</h3>
            <a class="btn btn-secondary" href="javascript:history.back()">
                <i class="fas fa-arrow-left"></i> Kembali
            </a>
        </div>
        <hr />

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <form asp-action="Create" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="card-body">
                        @if (ViewBag.Error != null)
                        {
                            <div class="alert alert-danger">@ViewBag.Error</div>
                        }

                        <input type="hidden" asp-for="PeralatanId" />
                        <input type="hidden" asp-for="BadgeNumber" />
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label">Kode APAR</label>
                                <input class="form-control" value="@Model.AparKode" readonly />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Lokasi</label>
                                <input class="form-control" value="@Model.LokasiNama" readonly />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Jenis</label>
                                <input class="form-control" value="@Model.JenisNama" readonly />
                            </div>
                        </div>

                        <hr />
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="TanggalPemeriksaan" class="form-label">Tanggal</label>
                                <input asp-for="TanggalPemeriksaan" type="date" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label asp-for="IntervalPetugasId" class="form-label">Interval (Override)</label>
                                <input asp-for="IntervalPetugasId" type="number" class="form-control"
                                    placeholder="Opsional, isi Id interval" />
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Kondisi" class="form-label">Kondisi</label>
                                <select asp-for="Kondisi" class="form-select">
                                    <option>Baik</option>
                                    <option>Perlu Perbaikan</option>
                                    <option>Rusak</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <label asp-for="Tekanan" class="form-label">Tekanan</label>
                                <input asp-for="Tekanan" class="form-control" type="number" step="0.1" />
                            </div>
                            <div class="col-md-4">
                                <label asp-for="JumlahMasalah" class="form-label">Jumlah Masalah</label>
                                <input asp-for="JumlahMasalah" class="form-control" type="number" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Petugas</label>
                                <input class="form-control" value="@Model.BadgeNumber" readonly />
                            </div>
                        </div>

                        <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <label asp-for="CatatanMasalah" class="form-label">Catatan Masalah</label>
                                <textarea asp-for="CatatanMasalah" rows="3" class="form-control"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Rekomendasi" class="form-label">Rekomendasi</label>
                                <textarea asp-for="Rekomendasi" rows="3" class="form-control"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="TindakLanjut" class="form-label">Tindak Lanjut</label>
                                <textarea asp-for="TindakLanjut" rows="3" class="form-control"></textarea>
                            </div>
                        </div>

                        <hr />
                        <div class="mb-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <strong>Checklist</strong>
                                <div class="small text-muted">
                                    Toggle cepat:
                                    <button class="btn btn-sm btn-outline-success" type="button"
                                        onclick="setAll(true)">Semua Baik</button>
                                    <button class="btn btn-sm btn-outline-danger" type="button"
                                        onclick="setAll(false)">Semua Tidak</button>
                                </div>
                            </div>
                        </div>

                        <div class="list-group">
                            @for (var i = 0; i < (Model.Checklist?.Count ?? 0); i++)
                            {
                                <div class="list-group-item">
                                    <input type="hidden" name="Checklist[@i].ChecklistId"
                                        value="@Model.Checklist[i].ChecklistId" />
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="me-3">
                                            <div class="fw-semibold">@Model.Checklist[i].PertanyaanChecklist</div>
                                            <div class="row g-2 mt-1">
                                                <div class="col-md-6">
                                                    <input name="Checklist[@i].Alasan" class="form-control form-control-sm"
                                                        placeholder="Alasan (opsional)" />
                                                </div>
                                                <div class="col-md-6">
                                                    <input name="Checklist[@i].Keterangan"
                                                        class="form-control form-control-sm"
                                                        placeholder="Keterangan (opsional)" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-nowrap">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input chk-ya" type="radio"
                                                    name="Checklist[@i].Jawaban" value="true" checked />
                                                <label class="form-check-label">Baik</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input chk-tidak" type="radio"
                                                    name="Checklist[@i].Jawaban" value="false" />
                                                <label class="form-check-label">Tidak</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <hr />
                        <div class="mb-3">
                            <label class="form-label">Upload Foto (opsional)</label>
                            <input type="file" name="fotos" class="form-control" accept="image/*" multiple
                                onchange="previewFiles(this)" />
                            <div id="preview" class="d-flex flex-wrap gap-2 mt-2"></div>
                        </div>
                    </div>

                    <div class="card-footer d-flex justify-content-between">
                        <a class="btn btn-outline-secondary" href="javascript:history.back()">
                            <i class="fas fa-arrow-left"></i> Batal
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan Pemeriksaan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <strong>Ringkasan</strong>
                </div>
                <div class="card-body">
                    <div class="small text-muted">APAR</div>
                    <div class="mb-2"><span class="badge bg-primary">@Model.AparKode</span></div>
                    <div class="small text-muted">Lokasi</div>
                    <div class="mb-2"><span class="badge bg-secondary">@Model.LokasiNama</span></div>
                    <div class="small text-muted">Jenis</div>
                    <div class="mb-2"><span class="badge bg-info text-dark">@Model.JenisNama</span></div>
                    <hr />
                    <div class="small text-muted">Petugas</div>
                    <div class="mb-2"><span class="badge bg-dark">@Model.BadgeNumber</span></div>
                    <div class="small text-muted">Tanggal</div>
                    <div>@Model.TanggalPemeriksaan:dd MMM yyyy</div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function setAll(isGood) {
            document.querySelectorAll('.list-group-item').forEach(item => {
                const radios = item.querySelectorAll('input[type="radio"]');
                const yes = item.querySelector('.chk-ya');
                const no = item.querySelector('.chk-tidak');
                if (isGood) { if (yes) yes.checked = true; } else { if (no) no.checked = true; }
            });
        }
        function previewFiles(input) {
            const cont = document.getElementById('preview');
            cont.innerHTML = '';
            if (!input.files) return;
            Array.from(input.files).forEach(f => {
                const url = URL.createObjectURL(f);
                const img = document.createElement('img');
                img.src = url;
                img.style.width = '90px';
                img.style.height = '90px';
                img.style.objectFit = 'cover';
                img.className = 'rounded border';
                cont.appendChild(img);
            });
        }
    </script>
}
