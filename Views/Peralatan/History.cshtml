@model List<AparAppsWebsite.Models.Peralatan>
@using System
@{
    ViewData["Title"] = "Riwayat Peralatan";
    var apiBase = (string?)ViewBag.ApiBase ?? "";
    var jenisFilter = ViewBag.FilterJenis as List<AparAppsWebsite.Models.DropdownItem> ?? new();
    var lokasiFilter = ViewBag.FilterLokasi as List<AparAppsWebsite.Models.DropdownItem> ?? new();
    string q = ViewBag.Query as string ?? "";
    string jenisIdQ = ViewBag.JenisId != null ? ViewBag.JenisId.ToString() : "";
    string lokasiIdQ = ViewBag.LokasiId != null ? ViewBag.LokasiId.ToString() : "";
    string sortBy = ViewBag.SortBy as string ?? "Kode";
    string sortDir = ViewBag.SortDir as string ?? "ASC";
    int curPage = ViewBag.Page ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int total = (ViewBag.Total as int?) ?? (Model?.Count ?? 0);
    int totalPages = (int)Math.Ceiling(total / Math.Max(1.0, pageSize));
    int safeCur = Math.Max(1, Math.Min(Math.Max(1, totalPages), curPage));
    int startIdx = total == 0 ? 0 : (safeCur - 1) * pageSize + 1;
    int endIdx = Math.Min(safeCur * pageSize, total);

    Func<string, string> ToggleDir = col =>
    (string.Equals(sortBy, col, StringComparison.OrdinalIgnoreCase) && sortDir.Equals("ASC",
    StringComparison.OrdinalIgnoreCase))
    ? "DESC" : "ASC";

    bool sKodeAct = sortBy.Equals("Kode", StringComparison.OrdinalIgnoreCase);
    bool sLokAct = sortBy.Equals("Lokasi", StringComparison.OrdinalIgnoreCase);
    bool sJenAct = sortBy.Equals("Jenis", StringComparison.OrdinalIgnoreCase);
    bool sStaAct = sortBy.Equals("Status", StringComparison.OrdinalIgnoreCase);
    bool sExpAct = sortBy.Equals("Exp_Date", StringComparison.OrdinalIgnoreCase);
    bool sUpdAct = sortBy.Equals("Updated", StringComparison.OrdinalIgnoreCase);
    string caret = sortDir.Equals("ASC", StringComparison.OrdinalIgnoreCase) ? "↑" : "↓";
    object commonRoute(int page) => new { q, jenisId = jenisIdQ, lokasiId = lokasiIdQ, page, pageSize, sortBy, sortDir };

    string sKodeUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Kode",
        sortDir = ToggleDir("Kode")
    }) ?? "#";
    string sLokUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Lokasi",
        sortDir = ToggleDir("Lokasi")
    }) ?? "#";
    string sJenUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Jenis",
        sortDir = ToggleDir("Jenis")
    }) ?? "#";
    string sStaUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Status",
        sortDir = ToggleDir("Status")
    }) ?? "#";
    string sExpUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Exp_Date",
        sortDir = ToggleDir("Exp_Date")
    }) ?? "#";
    string sUpdUrl = Url.Action("Expired", new
    {
        q,
        jenisId = jenisIdQ,
        lokasiId = lokasiIdQ,
        page = 1,
        pageSize,
        sortBy =
    "Updated",
        sortDir = ToggleDir("Updated")
    }) ?? "#";
    string prevUrl = Url.Action("Expired", commonRoute(Math.Max(1, safeCur - 1))) ?? "#";
    string nextUrl = Url.Action("Expired", commonRoute(Math.Min(Math.Max(1, totalPages), safeCur + 1))) ?? "#";
    Func<int, string> pg = (int p) => Url.Action("Expired", commonRoute(p)) ?? "#";
}

<style>
    .toolbar .form-control,
    .toolbar .form-select {
        min-width: 180px;
    }

    .toolbar .btn {
        border-radius: .45rem;
    }

    .k-chip {
        font-size: .8rem;
        border: 1px solid rgba(0, 0, 0, .06);
        background: var(--bs-light);
    }

    .sticky-head th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--bs-body-bg);
    }

    .table thead th {
        white-space: nowrap;
    }

    .table-hover tbody tr:hover {
        filter: brightness(.98);
    }

    .thumb {
        height: 50px;
        width: 50px;
        object-fit: cover;
        border-radius: .35rem;
        border: 1px solid rgba(0, 0, 0, .08);
    }

    .kode-badge {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
</style>

<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <partial name="~/Views/Shared/_Alerts.cshtml" />
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
                    <div>
                        <h3 class="card-title mb-0">Riwayat Peralatan <span class="badge bg-dark"></span></h3>
                        @* <div class="small text-muted">Menampilkan hanya peralatan yang sudah <b>Exp</b> atau <b>Exp.
                                Date</b> lewat hari ini.</div> *@
                    </div>

                    <form method="get" class="d-flex flex-wrap align-items-end gap-2">
                        <input type="hidden" name="sortBy" value="@sortBy" />
                        <input type="hidden" name="sortDir" value="@sortDir" />
                        <input type="hidden" name="page" value="1" />

                        <div>
                            <label class="form-label small text-muted">Pencarian</label>
                            <input class="form-control" name="q" value="@q"
                                placeholder="Cari kode / lokasi / jenis / ket / spesifikasi" />
                        </div>

                        <div>
                            <label class="form-label small text-muted">Filter Jenis</label>
                            <select class="form-select" name="jenisId">
                                <option value="">— Semua Jenis —</option>
                                @foreach (var j in jenisFilter)
                                {
                                    <option value="@j.Id" selected="@(jenisIdQ == j.Id.ToString() ? "selected" : null)">
                                        @j.Nama</option>
                                }
                            </select>
                        </div>

                        <div>
                            <label class="form-label small text-muted">Filter Lokasi</label>
                            <select class="form-select" name="lokasiId">
                                <option value="">— Semua Lokasi —</option>
                                @foreach (var l in lokasiFilter)
                                {
                                    <option value="@l.Id" selected="@(lokasiIdQ == l.Id.ToString() ? "selected" : null)">
                                        @l.Nama</option>
                                }
                            </select>
                        </div>

                        <div>
                            <label class="form-label small text-muted">Per halaman</label>
                            <select class="form-select" name="pageSize" onchange="this.form.submit()">
                                <option value="10" selected="@(pageSize == 10 ? "selected" : null)">10</option>
                                <option value="20" selected="@(pageSize == 20 ? "selected" : null)">20</option>
                                <option value="50" selected="@(pageSize == 50 ? "selected" : null)">50</option>
                                <option value="100" selected="@(pageSize == 100 ? "selected" : null)">100</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" type="submit">
                                <i class="fas fa-search"></i> Terapkan
                            </button>
                            <a class="btn btn-light border" href="@Url.Action("Expired")">
                                <i class="fas fa-undo"></i> Reset
                            </a>
                            <a class="btn btn-outline-primary" href="@Url.Action("Index")">← Kembali ke daftar aktif</a>
                        </div>
                    </form>
                </div>

                <div class="card-body">
                    @if (Model is { Count: > 0 })
                    {
                        <div class="mb-2 small text-muted">
                            Menampilkan <b>@startIdx-@endIdx</b> dari <b>@total</b> data.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-head">
                                    <tr>
                                        <th><a class="@(sKodeAct ? "fw-semibold" : "")" href="@sKodeUrl">Kode <span
                                                    class="text-muted">@(sKodeAct? caret : "↕")</span></a></th>
                                        <th><a class="@(sLokAct ? "fw-semibold" : "")" href="@sLokUrl">Lokasi <span
                                                    class="text-muted">@(sLokAct? caret : "↕")</span></a></th>
                                        <th><a class="@(sJenAct ? "fw-semibold" : "")" href="@sJenUrl">Jenis <span
                                                    class="text-muted">@(sJenAct? caret : "↕")</span></a></th>
                                        <th><a class="@(sStaAct ? "fw-semibold" : "")" href="@sStaUrl">Status <span
                                                    class="text-muted">@(sStaAct? caret : "↕")</span></a></th>
                                        <th><a class="@(sExpAct ? "fw-semibold" : "")" href="@sExpUrl">Tanggal Expired <span
                                                    class="text-muted">@(sExpAct? caret : "↕")</span></a></th>
                                        <th><a class="@(sUpdAct ? "fw-semibold" : "")" href="@sUpdUrl">Tanggal Update <span
                                                    class="text-muted">@(sUpdAct? caret : "↕")</span></a></th>
                                        <th>Spesifikasi</th>
                                        <th>Keterangan</th>
                                        <th>Foto</th>
                                        <th class="text-end">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var x in Model)
                                    {
                                        var foto = (x.FotoUrls ?? new List<string>()).FirstOrDefault();
                                        if (string.IsNullOrWhiteSpace(foto) && !string.IsNullOrWhiteSpace(x.FotoPath))
                                        {
                                            var parts = (x.FotoPath ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries |
                                            StringSplitOptions.TrimEntries);
                                            var rel = parts.FirstOrDefault();
                                            if (!string.IsNullOrWhiteSpace(rel))
                                                foto = (rel.StartsWith("http", StringComparison.OrdinalIgnoreCase)) ? rel :
                                                $"{apiBase}{rel}";
                                        }
                                        <tr>
                                            <td><span class="badge bg-secondary kode-badge">@x.Kode</span></td>
                                            <td>@(string.IsNullOrWhiteSpace(x.LokasiNama) ? "-" : x.LokasiNama)</td>
                                            <td>@(string.IsNullOrWhiteSpace(x.JenisNama) ? "-" : x.JenisNama)</td>
                                            <td><span class="badge bg-dark">@(string.IsNullOrWhiteSpace(x.Status) ? "Exp" :
                                                                                                x.Status)</span></td>
                                            <td>@(x.Exp_Date.HasValue? x.Exp_Date.Value.ToString("yyyy-MM-dd") : "-")</td>
                                            <td>@(x.Tanggal_Update_Alat.HasValue?
                                                                                    x.Tanggal_Update_Alat.Value.ToString("yyyy-MM-dd HH:mm") : "-")</td>
                                            <td class="small text-muted">@(!string.IsNullOrWhiteSpace(x.Spesifikasi)?
                                                                                        x.Spesifikasi : "-")</td>
                                            <td class="small">@(!string.IsNullOrWhiteSpace(x.Keterangan) ? x.Keterangan : "-")
                                            </td>
                                            <td>@if (!string.IsNullOrWhiteSpace(foto)) {
                                                <img src="@foto" class="thumb" />
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group">
                                                <a class="btn btn-sm btn-outline-secondary" asp-action="Details"
                                                    asp-route-id="@x.Id" title="Detail"><i class="fas fa-eye"></i></a>
                                                @* <a class="btn btn-sm btn-warning" asp-action="Edit" asp-route-id="@x.Id" title="Edit"><i class="fas fa-edit"></i></a> *@
                                                @* <a class="btn btn-sm btn-info" asp-action="QR" asp-route-id="@x.Id"
                                                    title="QR"><i class="fas fa-qrcode"></i></a> *@
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="small text-muted">Menampilkan <b>@startIdx</b>–<b>@endIdx</b> dari <b>@total</b>.
                        </div>
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item @(safeCur == 1 ? "disabled" : "")"><a class="page-link"
                                        href="@prevUrl">‹</a></li>
                                @for (int p = Math.Max(1, safeCur - 2); p <= Math.Min(totalPages, safeCur + 2); p++)
                                {
                                    <li class="page-item @(p == safeCur ? "active" : "")"><a class="page-link"
                                            href="@pg(p)">@p</a></li>
                                }
                                <li class="page-item @(safeCur == totalPages ? "disabled" : "")"><a class="page-link"
                                        href="@nextUrl">›</a></li>
                            </ul>
                        </nav>
                    </div>
                                        }
                                        else
                    {
                        <div class="alert alert-info">Tidak ada Riwayat Peralatan.</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
