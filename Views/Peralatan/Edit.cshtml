@model AparAppsWebsite.Models.Peralatan
@{
  ViewData["Title"] = "Edit Peralatan";
  var apiBase = (string?)ViewBag.ApiBase ?? "";
  var fotos = Model.FotoUrls ?? new List<string>();
  if (!fotos.Any() && !string.IsNullOrWhiteSpace(Model.FotoPath))
  {
    var parts = (Model.FotoPath ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    fotos = parts.Select(p => p.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? p : $"{apiBase}{p}").ToList();
  }
}
<partial name="~/Views/Shared/_Alerts.cshtml" />
<h2 class="mb-3">Edit Peralatan - @Model.Kode</h2>

<form asp-action="Edit" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" class="mb-4">
  @Html.AntiForgeryToken()
  <partial name="_Form" model="Model" />

  <div class="mb-3">
    <label class="form-label">Tambah Foto</label>
    <input type="file" name="files" class="form-control" multiple />
    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" id="replacePhotos" name="replacePhotos" value="true" />
      <label for="replacePhotos" class="form-check-label">Ganti total foto (bukan tambah)</label>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-primary" type="submit">Simpan</button>
    <a asp-action="Index" class="btn btn-outline-secondary">Kembali</a>
  </div>
</form>

<!-- DANGER ZONE -->
<div class="card border-danger mt-4">
  <div class="card-header bg-danger text-white"><strong>Danger Zone</strong></div>
  <div class="card-body">
    <p class="mb-3">Tindakan ini <strong>tidak menghapus</strong> data, tetapi menandai peralatan dengan status
      tertentu.
      Tanggal update akan otomatis diisi dari server.
    </p>

    <form asp-action="MarkExpired" method="post" class="row g-2" onsubmit="return confirm('Rubah Status Alat?');">
      @Html.AntiForgeryToken()
      <input type="hidden" name="id" value="@Model.Id" />

      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" name="status">
          <option value="Exp" selected>Exp</option>
          <option value="Rusak">Rusak</option>
          <option value="Hapus">Hapus</option>
        </select>
        <div class="form-text">Status yang akan diset.</div>
      </div>

      <div class="col-md-9">
        <label class="form-label">Keterangan <span class="text-danger">*</span></label>
        <input name="reason" class="form-control" placeholder="Wajib diisi (alasan perubahan status)" required />
      </div>

      <div class="col-12 mt-2">
        <button class="btn btn-danger"><i class="fas fa-exclamation-triangle me-1"></i> Update Status</button>
      </div>
    </form>
  </div>
</div>

@if (fotos.Any())
{
  <h5 class="mt-4">Foto Saat Ini</h5>
  <div class="row row-cols-2 row-cols-md-4 g-3">
    @foreach (var url in fotos)
    {
      <div class="col">
        <div class="card">
          <img class="card-img-top" src="@url" style="height:180px;object-fit:cover;" />
          <div class="card-body">
            <form asp-action="DeletePhoto" method="post" onsubmit="return confirm('Hapus foto ini?');">
              @Html.AntiForgeryToken()
              <input type="hidden" name="id" value="@Model.Id" />
              <input type="hidden" name="path" value="@url.Replace((string)ViewBag.ApiBase, "")" />
              <button class="btn btn-sm btn-outline-danger w-100" type="submit">Hapus</button>
            </form>
          </div>
        </div>
      </div>
    }
  </div>
}
@section Scripts {
  <partial name="_ValidationScriptsPartial" />
}
